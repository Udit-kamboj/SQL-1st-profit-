WITH T1 AS (SELECT DISTINCT A.ROW_ID AS RID, B.ROW_ID, C.ROW_ID, D.ROW_ID, E.ROW_ID,F.ROW_ID, G.ROW_ID,I.ROW_ID, A.ORDER_NUM ORD_NUM,
A.X_TOTAL_SELLING_PRICE T_SEL_PRI, A.X_COST_BASED_CAMPAIGN COS_BAS_CAM,
C.X_OUTSOURCING_PARTS_FLG OUT_SOR_FLG, D.TYPE PROD_TYPE,
E.X_INTERNAL_EXTERNAL_CLASSIFY MF_INT_CLASS, F.X_PO_COST_PRICE SER_PO_COST,
B.QTY_REQ QTY_REQ, D.DOORS_TYPE_CD KIT_5SC_CODE, G.COST_PRI COST_X,
A.X_SALES_COMMISSION_AMOUNT SAL_COM_AMT, H.NET_PRI AS OUT_TOTAL_TAX,
A.PAR_ORDER_ID AS PAR_ORD_ID
FROM SIEBEL.S_ORDER A
LEFT JOIN SIEBEL.S_ORDER_ITEM B
ON A.ROW_ID = B.ORDER_ID
LEFT JOIN SIEBEL.S_ACT_PRDINT C
ON C.Row_ID = B.X_ACT_PART_ID
LEFT JOIN SIEBEL.S_PROD_INT D
ON D.ROW_ID = B.PROD_ID
LEFT JOIN SIEBEL.S_EVT_ACT E
ON E.ROW_ID = C.ACTIVITY_ID
LEFT JOIN SIEBEL.S_QUOTE_ITEM F
ON F.ROW_ID = B.PROD_FAV_ITM_ID
LEFT JOIN SIEBEL.S_ORDER_ITM_PRI G
ON B.ROW_ID = G.ROW_ID
LEFT JOIN SIEBEL.S_ORDER_ITEM H
ON A.Row_ID = H.ORDER_ID
LEFT JOIN SIEBEL.S_PROD_INT I
ON I.ROW_ID = H.PROD_ID
WHERE A.ROW_ID = '1-1X341GH'
AND I.PART_NUM = 'YN4Z'
AND A.ORDER_CAT_CD = 'Sales'),

T2 AS (SELECT RID, ORD_NUM, T_SEL_PRI, PAR_ORD_ID, OUT_SOR_FLG, PROD_TYPE, MF_INT_CLASS, COS_BAS_CAM,
CASE WHEN (OUT_SOR_FLG = 'Y' OR PROD_TYPE = 'Labor') AND MF_INT_CLASS <> 'MFTBC mechanic' THEN 'Y'
ELSE 'N' END AS NV_SV_CHECK, SER_PO_COST, QTY_REQ,KIT_5SC_CODE,COST_X,
CASE WHEN KIT_5SC_CODE IS NULL THEN CASE WHEN COST_X IS NULL THEN 0 ELSE COST_X END
ELSE 0 END AS COST_NON_KIT,SAL_COM_AMT,
CASE WHEN SAL_COM_AMT IS NULL THEN 0 ELSE SAL_COM_AMT END AS SALE_COM_AMNT, OUT_TOTAL_TAX FROM T1),

T3 AS (SELECT RID, T_SEL_PRI,PAR_ORD_ID, ORD_NUM, COS_BAS_CAM,
SUM(CASE WHEN NV_SV_CHECK = 'Y' THEN SER_PO_COST
ELSE QTY_REQ * COST_NON_KIT END) AS MF_TOTAL_COST,
SALE_COM_AMNT, OUT_TOTAL_TAX
FROM T2
GROUP BY RID, T_SEL_PRI, SALE_COM_AMNT, OUT_TOTAL_TAX, PAR_ORD_ID, ORD_NUM, COS_BAS_CAM),

T4 AS 
(SELECT A.ROW_ID RID, COUNT(B.ROW_ID) AS CNT
FROM SIEBEL.S_ORDER A
LEFT JOIN SIEBEL.S_ORDER B
ON A.ROW_ID = B.CLAIM_ID
LEFT JOIN SIEBEL.S_ORDER_TYPE C
ON B.ORDER_TYPE_ID = C.ROW_ID
INNER JOIN T3
ON A.ROW_ID = T3.RID
WHERE C.NAME = 'UV Purchase Order'
GROUP BY A.ROW_ID),

T5 as (SELECT DISTINCT T3.RID AS ROD, T3.ORD_NUM ORD_NUM, T3.T_SEL_PRI T_SEL_PRI, T3.PAR_ORD_ID PAR_ORD_ID, T3.COS_BAS_CAM COS_BAS_CAM,
T3.MF_TOTAL_COST MF_TOT_COST, T3.SALE_COM_AMNT SALE_COM_AMNT, T3.OUT_TOTAL_TAX OUT_TOTAL_TAX , T4.CNT CNT
FROM T3
LEFT JOIN T4
ON T3.RID = T4.RID),

T6 AS 
(SELECT A.ROW_ID RID,
CASE WHEN X_TRADE_IN_AMNT <= C.X_ASSESSMENT_MIN_PRICE THEN C.X_ASSESSMENT_MIN_PRICE
ELSE CASE WHEN X_TRADE_IN_AMNT >= C.X_ASSESSMENT_MAX_PRICE THEN C.X_ASSESSMENT_MAX_PRICE
	ELSE  X_TRADE_IN_AMNT END
END AS MF_PROF_CALC, X_TRADE_IN_AMNT
FROM SIEBEL.S_ORDER A
LEFT JOIN SIEBEL.S_QUOTE_ITEM B
ON A.QUOTE_ID = B.SD_ID
LEFT JOIN SIEBEL.S_SRV_REQ C
ON C.ROW_ID = B.X_ASSESSMENT_ID
INNER JOIN T3
ON A.ROW_ID = T3.RID
WHERE B.ASSET_ID IS NOT NULL),

T7 AS (SELECT T5.ROD RID, T5.T_SEL_PRI T_SEL_PRI, T5.ORD_NUM ORD_NUM, T5.MF_TOT_COST MF_TOT_COST, T5.SALE_COM_AMNT SALE_COM_AMNT,
T5.OUT_TOTAL_TAX OUT_TOTAL_TAX, T5.CNT CNT, T5.PAR_ORD_ID PAR_ORD_ID, T5.COS_BAS_CAM COS_BAS_CAM,
CASE WHEN (T6.MF_PROF_CALC - T6.X_TRADE_IN_AMNT) IS NULL THEN 0
ELSE (T6.MF_PROF_CALC - T6.X_TRADE_IN_AMNT) END AS TRAD_iN_PRF
FROM T5
LEFT JOIN T6
ON T5.ROD = T6.RID),

T8 AS (SELECT RID, ORD_NUM, T_SEL_PRI, T7.MF_TOT_COST, SALE_COM_AMNT, OUT_TOTAL_TAX, CNT, COS_BAS_CAM,
PAR_ORD_ID, CASE WHEN SUM(TRAD_iN_PRF) IS NULL THEN 0 ELSE SUM(TRAD_iN_PRF) END AS SUM_TRD_PRF
FROM T7
GROUP BY RID, T_SEL_PRI, T7.MF_TOT_COST, SALE_COM_AMNT, OUT_TOTAL_TAX, CNT, PAR_ORD_ID, ORD_NUM, COS_BAS_CAM)

SELECT  ORD_NUM, T_SEL_PRI - (MF_TOT_COST + SALE_COM_AMNT + OUT_TOTAL_TAX - (CASE WHEN (PAR_ORD_ID IS NULL OR CNT > 0) THEN SUM_TRD_PRF ELSE 0 END))  AS FIRST_PRO,
COS_BAS_CAM
FROM T8;
